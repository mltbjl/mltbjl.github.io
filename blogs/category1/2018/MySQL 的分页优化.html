<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL 的分页优化 | 麻辣烫不加辣</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="头标.png">
    <meta name="description" content="""his is myblog">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.0ab6a768.css" as="style"><link rel="preload" href="/assets/js/app.faa17523.js" as="script"><link rel="preload" href="/assets/js/3.d40710ef.js" as="script"><link rel="preload" href="/assets/js/1.7e378398.js" as="script"><link rel="preload" href="/assets/js/19.f2e0e249.js" as="script"><link rel="prefetch" href="/assets/js/10.66a2476e.js"><link rel="prefetch" href="/assets/js/11.fb7d12d0.js"><link rel="prefetch" href="/assets/js/12.a9e9c0c2.js"><link rel="prefetch" href="/assets/js/13.6a93ecf1.js"><link rel="prefetch" href="/assets/js/14.be681b15.js"><link rel="prefetch" href="/assets/js/15.c3f94c5e.js"><link rel="prefetch" href="/assets/js/16.553281df.js"><link rel="prefetch" href="/assets/js/17.dfe6141d.js"><link rel="prefetch" href="/assets/js/18.1751d85f.js"><link rel="prefetch" href="/assets/js/20.e940d874.js"><link rel="prefetch" href="/assets/js/21.5f7d4709.js"><link rel="prefetch" href="/assets/js/22.bb3d4add.js"><link rel="prefetch" href="/assets/js/23.f36bc449.js"><link rel="prefetch" href="/assets/js/24.5020b4da.js"><link rel="prefetch" href="/assets/js/25.8c61ea18.js"><link rel="prefetch" href="/assets/js/26.95fcf31d.js"><link rel="prefetch" href="/assets/js/27.b3500f6e.js"><link rel="prefetch" href="/assets/js/28.bd6e122c.js"><link rel="prefetch" href="/assets/js/29.6196297d.js"><link rel="prefetch" href="/assets/js/30.e10cee0b.js"><link rel="prefetch" href="/assets/js/31.8e89e0e4.js"><link rel="prefetch" href="/assets/js/32.4fffa058.js"><link rel="prefetch" href="/assets/js/33.bfd6421c.js"><link rel="prefetch" href="/assets/js/34.dd051c60.js"><link rel="prefetch" href="/assets/js/35.22b02e0e.js"><link rel="prefetch" href="/assets/js/36.6d34fd45.js"><link rel="prefetch" href="/assets/js/37.51aa0fff.js"><link rel="prefetch" href="/assets/js/38.dcd289ce.js"><link rel="prefetch" href="/assets/js/39.70de9eaf.js"><link rel="prefetch" href="/assets/js/4.51cbaa00.js"><link rel="prefetch" href="/assets/js/40.88d489fb.js"><link rel="prefetch" href="/assets/js/41.bcbda0f8.js"><link rel="prefetch" href="/assets/js/42.54f797c2.js"><link rel="prefetch" href="/assets/js/43.3f32ba16.js"><link rel="prefetch" href="/assets/js/44.251dd9e6.js"><link rel="prefetch" href="/assets/js/45.611cf99a.js"><link rel="prefetch" href="/assets/js/46.38fcf7e1.js"><link rel="prefetch" href="/assets/js/47.d3ba7f51.js"><link rel="prefetch" href="/assets/js/48.8c9e1a9f.js"><link rel="prefetch" href="/assets/js/49.02338805.js"><link rel="prefetch" href="/assets/js/5.78f022ed.js"><link rel="prefetch" href="/assets/js/50.192722b5.js"><link rel="prefetch" href="/assets/js/51.21bdb02f.js"><link rel="prefetch" href="/assets/js/52.48b4c347.js"><link rel="prefetch" href="/assets/js/53.993caab3.js"><link rel="prefetch" href="/assets/js/54.997ced4c.js"><link rel="prefetch" href="/assets/js/55.5ede185b.js"><link rel="prefetch" href="/assets/js/56.9636df42.js"><link rel="prefetch" href="/assets/js/57.3a9aeb00.js"><link rel="prefetch" href="/assets/js/58.31744a2f.js"><link rel="prefetch" href="/assets/js/59.d1b7fda5.js"><link rel="prefetch" href="/assets/js/6.1dbfeed7.js"><link rel="prefetch" href="/assets/js/60.a4895531.js"><link rel="prefetch" href="/assets/js/61.c02db56a.js"><link rel="prefetch" href="/assets/js/62.2e71a0a3.js"><link rel="prefetch" href="/assets/js/63.90234e4b.js"><link rel="prefetch" href="/assets/js/64.9181ec64.js"><link rel="prefetch" href="/assets/js/65.4ff48956.js"><link rel="prefetch" href="/assets/js/66.1d61bfe7.js"><link rel="prefetch" href="/assets/js/67.8708fa10.js"><link rel="prefetch" href="/assets/js/68.259b39a4.js"><link rel="prefetch" href="/assets/js/69.5ec8555c.js"><link rel="prefetch" href="/assets/js/7.613fbb1a.js"><link rel="prefetch" href="/assets/js/70.e1613f74.js"><link rel="prefetch" href="/assets/js/71.2c17a996.js"><link rel="prefetch" href="/assets/js/8.8cfbbdc8.js"><link rel="prefetch" href="/assets/js/9.35d202ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0ab6a768.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-5bb33761><div data-v-5bb33761><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-5bb33761 data-v-5bb33761><h3 class="title" data-v-59e6cb88>麻辣烫不加辣</h3> <p class="description" data-v-59e6cb88>&quot;&quot;his is myblog</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>考小拉</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div class="hide" data-v-5bb33761><header class="navbar" data-v-5bb33761><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/1e64b7cc830c848fe6800ffc14ab1d2.jpg" alt="麻辣烫不加辣" class="logo"> <span class="site-name">麻辣烫不加辣</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/学习小记/" class="nav-link"><i class="undefined"></i>
  学习小记
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      文件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-5bb33761></div> <aside class="sidebar" data-v-5bb33761><div class="personal-info-wrapper" data-v-1fad0c41 data-v-5bb33761><img src="/398f8e744c4ae5e78367ae601358966f_1.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <h3 class="name" data-v-1fad0c41>
    考小拉
  </h3> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>57</h3> <h6 data-v-1fad0c41>Articles</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>33</h3> <h6 data-v-1fad0c41>Tags</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link"><i class="iconfont reco-home"></i>
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      目录
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/学习小记/" class="nav-link"><i class="undefined"></i>
  学习小记
</a></li></ul></div></div><div class="nav-item"><a href="/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  标签
</a></div><div class="nav-item"><a href="/timeline/" class="nav-link"><i class="iconfont reco-date"></i>
  时间线
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      文件
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/docs/theme-reco/" class="nav-link"><i class="undefined"></i>
  vuepress-reco
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-message"></i>
      Contact
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://github.com/recoluan" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="iconfont reco-github"></i>
  GitHub
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-5bb33761><h3 class="title" data-v-59e6cb88>MySQL 的分页优化</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><span data-v-59e6cb88>考小拉</span>
          
        <span data-v-59e6cb88>2017 - </span>
        2024
      </a></span></div></div> <div data-v-5bb33761><div data-v-5bb33761><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">MySQL 的分页优化</h1> <div data-v-8a445198><i class="iconfont reco-account" data-v-8a445198><span data-v-8a445198>考小拉</span></i> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>10/4/2023</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>MySQL 的学习</span></i></div></div> <div class="theme-reco-content content__default"><p>该篇文章参考 <a href="https://mp.weixin.qq.com/s/i6FL1iRECiWZ1CCf_juxQQ" target="_blank" rel="noopener noreferrer">小林coding<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> ，同时<a href="https://www.jianshu.com/p/cf5d381ef637" target="_blank" rel="noopener noreferrer">建表语句参考这个博主<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；我建立的表的数据是 <strong>400w+</strong>。</p> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p><code>MySQL</code> 分页有什么性能问题？如何优化？</p> <p>既然我们有了建表语句，我就不重复了，这里我只说明一下：<code>id</code> 为我们的聚簇索引，即主键；<code>person_id</code> 为普通索引，也为非聚簇索引；</p> <p>要想实现分页，很容易联想到我们 <code>MySQL</code> 提供的 <code>limit</code> 字段，这里我们复习一下，<code>limit</code> 字段的用法：<a href="https://mmbiz.qpic.cn/mmbiz_png/AnAgeMhDIiak10WxVpianzxZicJKTb4Kg74LvjrBh7xiadCuBXbe6aSdBKWQiaVC6iaO6A7qCaJx3GpqpLdhHR39WZrw/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" target="_blank" rel="noopener noreferrer">图片<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- offset 为偏移量；size 是取出条目</span>
<span class="token comment">-- 比如说 limit 0,10 就是说从第一条开始，一共展示10条数据</span>
<span class="token keyword">limit</span> <span class="token keyword">offset</span><span class="token punctuation">,</span>size
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>OK，既然知道这个 <code>limit</code> 的用法，我们尝试使用一下：</p> <p>小试牛刀，我们获取第一页的数据，每页十条：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span>
<span class="token comment">-- 或者</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>第一百页就是：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">990</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>问题来了，同样都是拿 10 条数据，查询第 1 页和第 100 页的速度一样否？why？</p> <h2 id="sql-语句的执行过程"><a href="#sql-语句的执行过程" class="header-anchor">#</a> SQL 语句的执行过程</h2> <p><a href="https://mmbiz.qpic.cn/mmbiz_png/AnAgeMhDIiak10WxVpianzxZicJKTb4Kg74FUeAWfaCOvicElrZiasM9TodjcTCqJ8WV3PSTl4EEHSy1Nob6icNBao7g/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" target="_blank" rel="noopener noreferrer">图片<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><code>MySQL</code> 内部分为 <code>Server</code> 层以及存储引擎层，一般情况下都用 <code>innoDB</code> 存储引擎；</p> <p>简单说一下这个取数据的过程，客户端执行 <code>SQL</code>语句，<code>Server</code> 层进行对客户端发来的 <code>SQL</code> 语句进行解析、优化等操作后，<code>Server</code> 层的执行器开始调用存储引擎层的接口，将一行行数据取出，当这些数据完全符合要求，则会放在结果集中，最后返回给 <code>MySQL</code> 的客户端即可。</p> <h2 id="基于主键即聚簇索引的执行流程"><a href="#基于主键即聚簇索引的执行流程" class="header-anchor">#</a> 基于主键即聚簇索引的执行流程</h2> <p>首先我们先测试一下，取第一页的 10 条数据：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>耗时：0.027s</p> <p>执行流程：<code>select</code> 后面带的是 星号，<strong>也就是取出获得行数据的所有字段信息</strong>；<code>Server</code> 层会调用 <code>innodb</code> 引擎接口，在 <code>innodb</code> 里的主键索引中获取第 0 到 10 条<strong>完整行的数据</strong>，依次返回给 <code>Server</code> 层，并放到 <code>Server</code> 层的结果集中，返回给客户端看。</p> <p>那如果我们把 offset 搞大点；为990000</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">990000</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>耗时：0.366s</p> <p>哈哈，耗时瞬间上来了；我们来看看这个语句的 <code>limit</code> 的执行流程：<code>Server</code> 层执行器会调用 <code>innodb</code> 存储引擎的接口，由于这次的 <code>offset</code> 为 990000，会在 <code>innodb</code> 里的主键索引中获取到第 0 到 （990000 + 10）条完整行数据，返回给 <code>Server</code> 层之后根据 <code>offset</code> 的值挨个抛弃，最后只留下 <code>size</code> 条的数据，然后放到 <code>Server</code> 层的结果集中，返回给客户端。</p> <p>由此我们都可以猜出为什么后者的耗时那么长了，<code>limit 990000，10</code> 比 <code>limit 0，10</code> 更慢，是因为前者会取出 990000 + 10 条数据，然后丢弃前 990000 条数据；</p> <p>既然知道了这个耗时地方，我们如何处理呢？</p> <p>我们又知道我们取出的 990000 数据中是全字段数据，都没有用的，这又是一个耗时的操作；我们想办法<strong>只获取我们需要数据的全部字段值，不需要的字段尽量能少就少即可</strong>；基于这个想法我们可以修改一下我们的 <code>SQL</code> 语句</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> id <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">990000</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>耗时：0.288s</p> <p>优化了貌似也就这样哈哈，但是这也是一种优化的方案了。</p> <h2 id="基于非主键索引的limit执行过程"><a href="#基于非主键索引的limit执行过程" class="header-anchor">#</a> 基于非主键索引的limit执行过程</h2> <p>现在来看看非主键索引的 limit 执行过程；</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> person_id <span class="token keyword">limit</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>耗时：0.028s</p> <p>执行流程：<code>Server</code> 层会调用 <code>innodb</code> 存储引擎的接口，在 <code>innodb</code> 里的非主键索引中获取到了第 0 条到 第 10 条数据对应的主键索引后，<strong>回表到主键索引中找到对应的完整行数据</strong>，然后返回给 <code>Server</code> 层，<code>Server</code> 层将其放到结果集中，返回给客户端。</p> <p>加大一下 <code>offset</code> 来看看耗时：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> person_id <span class="token keyword">limit</span> <span class="token number">4000000</span><span class="token punctuation">,</span><span class="token number">10</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>耗时：3.445s</p> <p>哈哈，下图请看，在偏移量很大时候，回表的次数很多，优化器甚至不用索引了，直接全表扫描；所谓优化器是我们执行器在执行 <code>SQL</code> 之前，判断哪种执行计划代价更小，所以说，当数据量很大的时候，用 <code>limit offset</code> 过大时，非主键索引查询非常容易变成全表扫描！！！<a href="https://img-blog.csdnimg.cn/e7e5c8b049cb41a0bb5ab5bc3a9a144c.jpeg" target="_blank" rel="noopener noreferrer">图片<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><img src="https://img-blog.csdnimg.cn/e7e5c8b049cb41a0bb5ab5bc3a9a144c.jpeg" alt="img"></p> <p>当然也可以去优化的：想法就是我们不仅<strong>只要我们所需要的记录的全部字符，不需要的就不要拷贝了，而且还要避免回表操作；</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 t11<span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token keyword">select</span> id <span class="token keyword">from</span> t1 <span class="token keyword">order</span> <span class="token keyword">by</span> person_id <span class="token keyword">limit</span> <span class="token number">4000000</span><span class="token punctuation">,</span><span class="token number">100</span><span class="token punctuation">)</span> t12 <span class="token keyword">where</span> t11<span class="token punctuation">.</span>id <span class="token operator">=</span> t12<span class="token punctuation">.</span>id<span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>耗时：0.938s</p> <p>这里使用 <code>select id from t1 order by person_id limit 4000000,100</code> 先走 <code>innodb</code> 层的 <code>person_id</code> 非主键索引中获取到 <code>id</code> ，因为只拿 <code>id</code> 所以避免了回表操作；然后获取到了 4000000 + 100 的数据（只含 <code>id</code> 字段），然后抛弃了 前面的 4000000 条数据剩下最后的 100 条数据跟我们的 <code>t1</code> 表做匹配，这样将符合条件的匹配到 100 条数据返回即可。</p> <p>但是 方案都是没有绕开取前面 <code>offset</code> 那么大的数据，都是取出来了只是抛弃了而已。。。</p> <p>这就是所谓的 <strong>深度分页</strong> 问题了。</p> <h2 id="深度分页问题"><a href="#深度分页问题" class="header-anchor">#</a> 深度分页问题</h2> <p><strong>一般都是要规避这个深度分页的问题的</strong></p> <h3 id="如果想取出全表的数据"><a href="#如果想取出全表的数据" class="header-anchor">#</a> 如果想取出全表的数据</h3> <p>可以将所有的数据根据 <code>id</code> 主键进行排序完成后，然后分批获取，每次获取的时候都是上一次获取的最大 <code>id + 1</code> 作为条件进行查询；</p> <p>伪代码：<a href="https://mmbiz.qpic.cn/mmbiz_png/AnAgeMhDIiak10WxVpianzxZicJKTb4Kg74aQ9pYzcD7h1p2JhBEbtDQOsy68tk0OKDWBpTnssN2MZXhe7eWEbaBQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" target="_blank" rel="noopener noreferrer">图片<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>start_id:<span class="token number">0</span>
<span class="token keyword">for</span> {
	<span class="token comment">// 取数据</span>
	datas:<span class="token operator">=</span> <span class="token punctuation">[</span><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">where</span> id <span class="token operator">&gt;</span> start_id <span class="token keyword">order</span> <span class="token keyword">by</span> id <span class="token keyword">limit</span> <span class="token number">100</span><span class="token punctuation">]</span>
	<span class="token comment">// 没数据，说明遍历结束</span>
	<span class="token keyword">if</span> <span class="token function">len</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">=</span> <span class="token number">0</span> {
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	}
	<span class="token comment">// 处理每次得到的结果</span>
	<span class="token keyword">handler</span><span class="token punctuation">(</span>datas<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 获取datas中最大的id 赋值给 start_id 进入下一个循环</span>
	start_id <span class="token operator">=</span> getMaxIdFrom<span class="token punctuation">(</span>datas<span class="token punctuation">)</span><span class="token punctuation">;</span>
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h3 id="如果是给用户做分页展示"><a href="#如果是给用户做分页展示" class="header-anchor">#</a> 如果是给用户做分页展示</h3> <p>有谁会去看 20 页乃至 100 页的数据呢？</p> <p>所以我们可以参考一下谷歌的翻页功能：<a href="https://mmbiz.qpic.cn/mmbiz_png/AnAgeMhDIiak10WxVpianzxZicJKTb4Kg74gM3iaZRuXdvVsSSvSGuNKBJIS7PAmxXOA2TQxLymicualQCicK6Fsib8Ig/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" target="_blank" rel="noopener noreferrer">图片<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>  只展示前 20 个分页；</p> <p>如果可以的话 甚至可以考虑一下跳页？哈哈 上一页 下一页这样，就没有深度分页的问题了；包装一下？做成瀑布流，刷抖音的形式（<a href="https://mmbiz.qpic.cn/mmbiz_png/AnAgeMhDIiak10WxVpianzxZicJKTb4Kg74VFAwXUWbh56o9oY4bdunFZJcHJ5BrVNbYUT3UJGOBB5icAAPIZfW8tQ/640?wx_fmt=png&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" target="_blank" rel="noopener noreferrer">图片<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）？哈哈 都是可以的</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <ul><li><p>深度分页问题可以优化，但是不能完美解决；只能通过<strong>限制查询数量</strong>以及<strong>分批获取</strong>的方式进行优化；</p></li> <li><p>考虑一下原始的需求，结合业务去采取用哪一种分页方法；但是原则都是避开深度分页的场景的。</p></li></ul></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div> <ul class="side-bar sub-sidebar-wrapper" style="width:12rem;" data-v-ac050c62><li class="level-2" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#前言" class="sidebar-link reco-side-前言" data-v-ac050c62>前言</a></li><li class="level-2" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#sql-语句的执行过程" class="sidebar-link reco-side-sql-语句的执行过程" data-v-ac050c62>SQL 语句的执行过程</a></li><li class="level-2" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#基于主键即聚簇索引的执行流程" class="sidebar-link reco-side-基于主键即聚簇索引的执行流程" data-v-ac050c62>基于主键即聚簇索引的执行流程</a></li><li class="level-2" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#基于非主键索引的limit执行过程" class="sidebar-link reco-side-基于非主键索引的limit执行过程" data-v-ac050c62>基于非主键索引的limit执行过程</a></li><li class="level-2" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#深度分页问题" class="sidebar-link reco-side-深度分页问题" data-v-ac050c62>深度分页问题</a></li><li class="level-3" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#如果想取出全表的数据" class="sidebar-link reco-side-如果想取出全表的数据" data-v-ac050c62>如果想取出全表的数据</a></li><li class="level-3" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#如果是给用户做分页展示" class="sidebar-link reco-side-如果是给用户做分页展示" data-v-ac050c62>如果是给用户做分页展示</a></li><li class="level-2" data-v-ac050c62><a href="/blogs/category1/2018/MySQL%20%E7%9A%84%E5%88%86%E9%A1%B5%E4%BC%98%E5%8C%96.html#总结" class="sidebar-link reco-side-总结" data-v-ac050c62>总结</a></li></ul></main></div> <!----></div></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div></div></div>
    <script src="/assets/js/app.faa17523.js" defer></script><script src="/assets/js/3.d40710ef.js" defer></script><script src="/assets/js/1.7e378398.js" defer></script><script src="/assets/js/19.f2e0e249.js" defer></script>
  </body>
</html>
